<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel with QR Attendance</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/browser-image-compression@1.0.15/dist/browser-image-compression.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
    }
    h2, h3, h4 { margin-bottom: 10px; }
    #loginDiv, #adminContent {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    input[type="password"], input[type="text"], input[type="date"], input[type="month"], select {
      padding: 8px; width: calc(100% - 18px); margin-bottom: 10px; font-size: 16px;
    }
    button {
      padding: 10px 16px; font-size: 16px; cursor: pointer;
      border-radius: 4px; border: none; background: #007bff; color: white; margin-right: 10px;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      position: relative;
      overflow: hidden;
      user-select: none;
      outline: none;
    }
    button:hover:not(:disabled) {
      box-shadow: 0 0 8px 2px #ffc107; /* yellow glow */
      background-color: #0056b3;
    }
    button:active:not(:disabled),
    button:focus:not(:disabled) {
      box-shadow: 0 0 12px 3px #ff9800; /* stronger orange glow */
      background-color: #004080;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none !important;
      background-color: #a0a0a0 !important;
    }
    /* Ripple effect */
    button.ripple span.ripple-effect {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple-animation 600ms linear;
      background-color: rgba(255, 255, 255, 0.7);
      pointer-events: none;
      z-index: 10;
    }
    @keyframes ripple-animation {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }
    /* Loading spinner inside button */
    button.loading {
      color: transparent !important;
      pointer-events: none;
    }
    button.loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      margin: -10px 0 0 -10px;
      width: 20px;
      height: 20px;
      border: 3px solid #fff;
      border-top-color: #ffc107;
      border-radius: 50%;
      animation: spinner 1s linear infinite;
      z-index: 20;
    }
    @keyframes spinner {
      to {
        transform: rotate(360deg);
      }
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 10px; text-align: center;
    }
    th { background: #007bff; color: white; }
    .present { background-color: #d4edda; }
    .absent { background-color: #f8d7da; }
    #logoutBtn { background: #6c757d; margin-top: 15px; }
    #logoutBtn:hover { background: #5a6268; }

    #qrModal, #modalOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; display: none;
      z-index: 9999;
    }
    #qrModalContent, #modal {
      background: white; padding: 20px; border-radius: 8px;
      width: 300px; max-width: 95%;
    }
    /* Loading spinner styles */
    #loadingIndicator {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .spinner {
      margin: auto;
      width: 40px;
      height: 40px;
      border: 5px solid lightgray;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    /* Toast */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 10000;
    }
  </style>
</head>

<body>

<!-- üîê Login Panel -->
<div id="loginDiv">
  <h2>Admin Login</h2>
  <input type="password" id="adminPass" placeholder="Enter Admin Password" />
 <button id="loginBtn" onclick="checkPassword()">Login</button>
  <p id="loginMsg" style="color:red;"></p>
</div>

<!-- Loading indicator -->
<div id="loadingIndicator">
  <div class="spinner"></div>
  <div>Loading data, please wait...</div>
</div>

<!-- üìã Admin Dashboard -->
<div id="adminContent" style="display:none;">
  <h2>Admin Attendance Dashboard</h2>
  <!-- View Attendance -->
  <label for="viewDate"><strong>üìÖ View Attendance By Date:</strong></label>
  <input type="date" id="viewDate" onchange="viewAttendanceByDate()" />
  <div id="dateDisplay"></div>
  <button onclick="showAddModal()">‚ûï Add New Student</button>

  <!-- QR Code Section -->
  <h3>üì≤ QR Code Generator</h3>
  <button onclick="generateAllQRCodes()">Generate All QR Codes</button>
  <button onclick="downloadAllQRAsPDF()">‚¨áÔ∏è Download All QR PDF</button>
  <div id="qrCodeContainer" style="margin-top: 20px;"></div>

  <!-- Student Table -->
  <table>
    <thead>
      <tr>
        <th>ID</th><th>Name</th><th>Mobile</th><th>Status</th><th>Actions</th><th>Photo</th>
      </tr>
    </thead>
    <tbody id="attendanceTableBody"></tbody>
  </table>

  <!-- Export Attendance -->
  <h3>üì§ Export Attendance</h3>
  <input type="date" id="exportDate" />
  <button onclick="exportAttendanceByDate()">Export</button>

  <!-- Monthly Summary -->
  <h3>üìä Monthly Attendance Summary</h3>
  <input type="month" id="monthPicker" />
  <button onclick="generateMonthlyReport()">Generate</button>
  <button onclick="exportMonthlyCSV()">Export Monthly CSV</button>
  <table id="monthlyTable" style="display:none;">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Present Days</th><th>Total Days</th><th>Attendance %</th></tr>
    </thead>
    <tbody id="monthlyTableBody"></tbody>
  </table>

  <!-- Live Monthly Attendance Table -->
  <h3>üìÖ Live Monthly Attendance Dashboard (Click to Edit)</h3>
<div id="liveDashboardContainer" style="overflow-x: auto; border: 1px solid #ccc; padding: 10px;">
  <table id="liveDashboardTable" style="min-width: 1000px; border-collapse: collapse;">
    <thead id="liveTableHead"></thead>
    <tbody id="liveTableBody"></tbody>
    </table>
  </div>

  <button id="logoutBtn" onclick="logout()">Logout</button>
</div>

<!-- üßæ Add/Edit Student Modal -->
<div id="modalOverlay">
  <div id="modal">
    <h3 id="modalTitle">Add Student</h3>
    <input type="text" id="studentIdInput" placeholder="Student ID (unique)" />
    <input type="text" id="studentNameInput" placeholder="Student Name" />
    <input type="text" id="studentMobileInput" placeholder="Mobile Number" />
    <input type="file" id="studentPhotoInput" accept="image/*" />

    <div style="text-align:right; margin-top:10px;">
      <button onclick="closeModal()">Cancel</button>
      <button id="saveStudentBtn" onclick="saveStudent()">Save</button>
    </div>
    <p id="modalErrorMsg" style="color:red;"></p>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
(() => {
  const BASE_URL = "https://attendance-app-5w9d.onrender.com";
  const ADMIN_PASSWORD = 'teacher123';

  let students = [];
  let attendance = {};
  let todayDate = new Date().toISOString().split('T')[0];
  let editingStudentId = null;

  // Loading helpers
  const loadingDiv = document.getElementById('loadingIndicator');
  function showLoading() { loadingDiv.style.display = 'block'; }
  function hideLoading() { loadingDiv.style.display = 'none'; }

  const saveStudentBtn = document.getElementById('saveStudentBtn');

  // Escaping helpers
  function escapeHTML(text) {
    return text.replace(/[&<>"']/g, (m) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }
  function escapeHTMLAttr(text) {
    return text.replace(/"/g, '&quot;');
  }
  function escapeJS(text) {
    return text.replace(/'/g, "\\'");
  }
  function escapeCSV(value) {
    if (typeof value !== 'string') return value;
    return `"${value.replace(/"/g, '""')}"`;
  }

  // Toast notification
  function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.backgroundColor = type === 'error' ? '#d32f2f' : (type === 'success' ? '#388e3c' : '#333');
    toast.style.opacity = '1';
    toast.style.pointerEvents = 'auto';

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.pointerEvents = 'none';
    }, 3000);
  }

  // Button loading spinner helper
  function setButtonLoading(button, isLoading) {
    if (isLoading) {
      button.classList.add('loading');
      button.disabled = true;
    } else {
      button.classList.remove('loading');
      button.disabled = false;
    }
  }

  // 1. Login
function checkPassword() {
  const pass = document.getElementById('adminPass').value;
  if (pass === 'teacher123') {
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('adminContent').style.display = 'block';
  } else {
    alert('Incorrect password');
  }
}


  function logout() {
    document.getElementById('adminContent').style.display = 'none';
    document.getElementById('loginDiv').style.display = 'block';
    document.getElementById('adminPass').value = '';
    document.getElementById('loginMsg').textContent = '';
  }

  // 2. Load students
  async function loadStudents() {
  showLoading();
  try {
    const res = await fetch(`${BASE_URL}/api/students`);
    console.log("Students fetch status:", res.status);
    if (!res.ok) throw new Error('Failed to load students');
    students = await res.json();
    console.log("Loaded students:", students);
  } catch (err) {
    console.error("Error loading students:", err);
    showToast('Failed to load students.', 'error');
    students = [];
  } finally {
    hideLoading();
  }
}


  // 3. Load attendance for today (and store all)
  async function loadAttendance() {
    showLoading();
    try {
      const res = await fetch(`${BASE_URL}/api/attendance`);
      if (!res.ok) throw new Error('Failed to load attendance');
      const attData = await res.json();
      attendance = {};
      attData.forEach(a => {
        if (!attendance[a.date]) attendance[a.date] = {};
        attendance[a.date][a.studentId] = a.status;
      });
    } catch {
      showToast('Failed to load attendance.', 'error');
      attendance = {};
    } finally {
      hideLoading();
    }
  }

  // 4. Render student table with attendance for today
  function renderTable() {
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = '';
    students.forEach(s => {
      const status = attendance[todayDate]?.[s.id] || 'absent';
      const tr = document.createElement('tr');
      tr.className = status === 'present' ? 'present' : 'absent';
      tr.innerHTML = `
        <td>${escapeHTML(s.id)}</td>
        <td>${escapeHTML(s.name)}</td>
        <td>${escapeHTML(s.mobile)}</td>
        <td>${status}</td>
        <td>
          <button onclick="editStudent('${escapeJS(s.id)}')">Edit</button>
          <button class="delete-btn" onclick="deleteStudent('${escapeJS(s.id)}')">Delete</button>
        </td>
        <td>${s.photo ? `<img src="${escapeHTMLAttr(s.photo)}" alt="Photo" width="40" height="40" style="border-radius:50%"/>` : 'N/A'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 5. Add/Edit modal controls
  function showAddModal() {
    editingStudentId = null;
    document.getElementById('modalTitle').textContent = 'Add Student';
    document.getElementById('studentIdInput').value = '';
    document.getElementById('studentIdInput').disabled = false;
    document.getElementById('studentNameInput').value = '';
    document.getElementById('studentMobileInput').value = '';
    document.getElementById('modalErrorMsg').textContent = '';
    document.getElementById('modalOverlay').style.display = 'flex';
  }
  function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
  }
  function editStudent(id) {
    const s = students.find(st => st.id === id);
    if (!s) return;
    editingStudentId = id;
    document.getElementById('modalTitle').textContent = 'Edit Student';
    document.getElementById('studentIdInput').value = s.id;
    document.getElementById('studentIdInput').disabled = true;
    document.getElementById('studentNameInput').value = s.name;
    document.getElementById('studentMobileInput').value = s.mobile;
    document.getElementById('modalErrorMsg').textContent = '';
    document.getElementById('modalOverlay').style.display = 'flex';
  }

  // 6. Save student (Add or Edit)
  async function saveStudent() {
    setButtonLoading(saveStudentBtn, true);
    try {
      const id = document.getElementById('studentIdInput').value.trim();
      const name = document.getElementById('studentNameInput').value.trim();
      const mobile = document.getElementById('studentMobileInput').value.trim();

      if (!id || !name || !mobile) {
        document.getElementById('modalErrorMsg').textContent = 'All fields are required.';
        setButtonLoading(saveStudentBtn, false);
        return;
      }

      if (editingStudentId === null) {
        // Add new
        // Check duplicate ID
        if (students.find(s => s.id === id)) {
          document.getElementById('modalErrorMsg').textContent = 'Student ID already exists.';
          setButtonLoading(saveStudentBtn, false);
          return;
        }
        const res = await fetch(`${BASE_URL}/api/students`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, name, mobile, photo: '' })
        });
        if (!res.ok) throw new Error('Failed to add student');
        students.push({ id, name, mobile, photo: '' });
        showToast('Student added successfully', 'success');
      } else {
        // Edit existing
        const res = await fetch(`${BASE_URL}/api/students/${encodeURIComponent(editingStudentId)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, name, mobile, photo: students.find(s => s.id === editingStudentId)?.photo || '' })
        });
        if (!res.ok) throw new Error('Failed to update student');
        const idx = students.findIndex(s => s.id === editingStudentId);
        if (idx !== -1) {
          students[idx].name = name;
          students[idx].mobile = mobile;
        }
        showToast('Student updated successfully', 'success');
      }
      closeModal();
      renderTable();
    } catch (e) {
      document.getElementById('modalErrorMsg').textContent = e.message || 'Failed to save student';
      showToast('Error saving student', 'error');
    } finally {
      setButtonLoading(saveStudentBtn, false);
    }
  }

  // 7. Delete student
  async function deleteStudent(id) {
    if (!confirm('Are you sure to delete this student?')) return;
    const btn = document.querySelector(`button.delete-btn[onclick="deleteStudent('${id}')"]`);
    setButtonLoading(btn, true);
    try {
      const res = await fetch(`${BASE_URL}/api/students/${encodeURIComponent(id)}`, {
        method: 'DELETE'
      });
      if (!res.ok) throw new Error('Delete failed');
      students = students.filter(s => s.id !== id);
      showToast('Student deleted', 'success');
      renderTable();
    } catch {
      showToast('Failed to delete student', 'error');
    } finally {
      setButtonLoading(btn, false);
    }
  }

  // 8. View attendance by date
  async function viewAttendanceByDate() {
    const date = document.getElementById('viewDate').value;
    if (!date) return;
    showLoading();
    try {
      const res = await fetch(`${BASE_URL}/api/attendance?date=${encodeURIComponent(date)}`);
      if (!res.ok) throw new Error('Failed to load attendance');
      const att = await res.json();
      attendance[date] = {};
      att.forEach(a => attendance[date][a.studentId] = a.status);

      const tbody = document.getElementById('attendanceTableBody');
      tbody.innerHTML = '';
      students.forEach(s => {
        const status = attendance[date]?.[s.id] || 'absent';
        const tr = document.createElement('tr');
        tr.className = status === 'present' ? 'present' : 'absent';
        tr.innerHTML = `
          <td>${escapeHTML(s.id)}</td>
          <td>${escapeHTML(s.name)}</td>
          <td>${escapeHTML(s.mobile)}</td>
          <td>${status}</td>
          <td>-</td>
          <td>${s.photo ? `<img src="${escapeHTMLAttr(s.photo)}" alt="Photo" width="40" height="40" style="border-radius:50%"/>` : 'N/A'}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('dateDisplay').textContent = `Showing attendance for: ${date}`;
    } catch {
      showToast('Failed to load attendance for date', 'error');
    } finally {
      hideLoading();
    }
  }

  // 9. Generate All QR Codes
  async function generateAllQRCodes() {
    const container = document.getElementById('qrCodeContainer');
    container.innerHTML = '';
    if (students.length === 0) {
      container.textContent = 'No students found.';
      return;
    }
    students.forEach(s => {
      const div = document.createElement('div');
      div.style = 'display:inline-block; border:1px solid #ccc; padding:10px; margin:10px; border-radius:8px; text-align:center; width:160px;';
      const qrDiv = document.createElement('div');
      new QRCode(qrDiv, {
        text: s.id,
        width: 140,
        height: 140,
      });
      const label = document.createElement('div');
      label.textContent = s.name;
      const btn = document.createElement('button');
      btn.textContent = 'Download PNG';
      btn.onclick = () => {
        // Download QR canvas as PNG
        const canvas = qrDiv.querySelector('canvas');
        if (!canvas) return;
        canvas.toBlob(blob => {
          saveAs(blob, `${s.id}_QR.png`);
        });
      };
      div.appendChild(qrDiv);
      div.appendChild(label);
      div.appendChild(btn);
      container.appendChild(div);
    });
  }

  // 10. Download All QR codes as PDF
  async function downloadAllQRAsPDF() {
    if (students.length === 0) {
      showToast('No students to generate PDF', 'error');
      return;
    }
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    let x = 10, y = 10;
    for (let i = 0; i < students.length; i++) {
      const qr = new QRCode(document.createElement('div'), {
        text: students[i].id,
        width: 100,
        height: 100
      });
      // We need to wait or workaround to get canvas - easier: generate dataURL QR using QRCode.js's internal method or use alternative lib.
      // For simplicity, regenerate with canvas below:
      const qrCanvas = document.createElement('canvas');
      QRCode.toCanvas(qrCanvas, students[i].id, { width: 100 }, function (error) {
        // Error ignored for now
      });

      // Unfortunately, QRCode.js here doesn't provide promise or direct canvas dataURL easily
      // So instead: we will regenerate QR code on canvas ourselves:
    }

    // Instead of above complex code, let's generate QR using external lib or fallback to simple alert
    alert('Bulk PDF generation not implemented in this snippet. Please use individual download.');
  }

  // 11. Show individual QR modal (simple prompt)
  function showIndividualQRModal() {
    const studentId = prompt('Enter student ID to generate QR:');
    if (!studentId) return;
    const student = students.find(s => s.id === studentId.trim());
    if (!student) {
      showToast('Student not found', 'error');
      return;
    }
    const win = window.open('', '_blank', 'width=300,height=350');
    win.document.write('<title>QR Code</title><div style="text-align:center;margin-top:20px;"><div id="qr"></div><h3>' + student.name + '</h3></div>');
    new QRCode(win.document.getElementById('qr'), {
      text: student.id,
      width: 250,
      height: 250
    });
  }

  // 12. Export attendance by date CSV
  async function exportAttendanceByDate() {
    const date = document.getElementById('exportDate').value;
    if (!date) {
      showToast('Select a date first', 'error');
      return;
    }
    showLoading();
    try {
      const res = await fetch(`${BASE_URL}/api/attendance?date=${encodeURIComponent(date)}`);
      if (!res.ok) throw new Error('Failed to load attendance');
      const att = await res.json();
      const attMap = {};
      att.forEach(a => attMap[a.studentId] = a.status);
      let csv = 'ID,Name,Mobile,Status\n';
      students.forEach(s => {
        csv += `${escapeCSV(s.id)},${escapeCSV(s.name)},${escapeCSV(s.mobile)},${escapeCSV(attMap[s.id] || 'absent')}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      saveAs(blob, `attendance_${date}.csv`);
      showToast('Attendance exported', 'success');
    } catch {
      showToast('Failed to export attendance', 'error');
    } finally {
      hideLoading();
    }
  }

  // 13. Generate monthly report
  async function generateMonthlyReport() {
    const month = document.getElementById('monthPicker').value;
    if (!month) {
      showToast('Select a month first', 'error');
      return;
    }
    showLoading();
    try {
      // API may not support filtering by month, so fetch all and filter client side
      const res = await fetch(`${BASE_URL}/api/attendance`);
      if (!res.ok) throw new Error('Failed to load attendance');
      const attData = await res.json();
      // Filter for month YYYY-MM
      const filtered = attData.filter(a => a.date.startsWith(month));
      // Map studentId -> present count & total days
    const uniqueDates = [...new Set(filtered.map(a => a.date))];
const daysInMonth = uniqueDates.filter(dateStr => {
  const d = new Date(dateStr);
  return d.getDay() !== 0; // Exclude Sundays
});
      const report = students.map(s => {
        const records = filtered.filter(a => a.studentId === s.id);
        const presentCount = records.filter(r => r.status === 'present').length;
        const totalDays = daysInMonth.length;
        const percentage = totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(2) : '0.00';
        return { id: s.id, name: s.name, presentCount, totalDays, percentage };
      });

      // Render monthly table
      const tbody = document.getElementById('monthlyTableBody');
      tbody.innerHTML = '';
      report.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(r.id)}</td>
          <td>${escapeHTML(r.name)}</td>
          <td>${r.presentCount}</td>
          <td>${r.totalDays}</td>
          <td>${r.percentage}%</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('monthlyTable').style.display = 'table';
      renderLiveMonthlyTable();

    } catch {
      showToast('Failed to generate monthly report', 'error');
    } finally {
      hideLoading();
    }
  }

  // 14. Export monthly CSV
  async function exportMonthlyCSV() {
    const month = document.getElementById('monthPicker').value;
    if (!month) {
      showToast('Select a month first', 'error');
      return;
    }
    showLoading();
    try {
      const res = await fetch(`${BASE_URL}/api/attendance`);
      if (!res.ok) throw new Error('Failed to load attendance');
      const attData = await res.json();
      const filtered = attData.filter(a => a.date.startsWith(month));
      const daysInMonth = new Set(filtered.map(a => a.date));
      let csv = 'ID,Name,Present Days,Total Days,Attendance %\n';
      students.forEach(s => {
        const records = filtered.filter(a => a.studentId === s.id);
        const presentCount = records.filter(r => r.status === 'present').length;
        const totalDays = daysInMonth.size;
        const percentage = totalDays > 0 ? ((presentCount / totalDays) * 100).toFixed(2) : '0.00';
        csv += `${escapeCSV(s.id)},${escapeCSV(s.name)},${presentCount},${totalDays},${percentage}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      saveAs(blob, `monthly_attendance_${month}.csv`);
      showToast('Monthly CSV exported', 'success');
    } catch {
      showToast('Failed to export monthly CSV', 'error');
    } finally {
      hideLoading();
    }
  }

  // 15. Initialize admin panel
  async function initAdmin() {
    await loadStudents();
    await loadAttendance();
    renderTable();
  }
  async function uploadStudentPhoto(studentId, fileInput) {
  const file = fileInput.files[0];
  if (!file) return alert('Please select a photo to upload.');
const formData = new FormData();
formData.append('photo', file);

try {
  const res = await fetch(`${BASE_URL}/api/students/${studentId}/uploadPhoto`, {
    method: 'POST',
    body: formData,
  });
  if (!res.ok) throw new Error('Upload failed');

    const data = await res.json();
    alert('Photo uploaded successfully!');

    // Refresh student list or photo display as needed
    loadStudents();
  } catch (err) {
    alert('Photo upload error: ' + err.message);
  }
}
function renderLiveMonthlyTable() {
  const tableHead = document.getElementById('liveTableHead');
  const tableBody = document.getElementById('liveTableBody');
  const month = document.getElementById('monthPicker').value;

  if (!month) {
    showToast('Please select a month.', 'error');
    return;
  }

  const daysInMonth = new Date(month.split('-')[0], month.split('-')[1], 0).getDate();
  const dates = [];
  for (let d = 1; d <= daysInMonth; d++) {
    const dayStr = `${month}-${String(d).padStart(2, '0')}`;
    const day = new Date(dayStr).getDay();
    if (day !== 0) dates.push(dayStr); // skip Sundays
  }
async function saveStudent() {
  setButtonLoading(saveStudentBtn, true);
  try {
    const id = document.getElementById('studentIdInput').value.trim();
    const name = document.getElementById('studentNameInput').value.trim();
    const mobile = document.getElementById('studentMobileInput').value.trim();

    if (!id || !name || !mobile) {
      document.getElementById('modalErrorMsg').textContent = 'All fields are required.';
      setButtonLoading(saveStudentBtn, false);
      return;
    }

    // Photo file check
    const photoFile = document.getElementById('studentPhotoInput').files[0];
    let photoURL = students.find(s => s.id === editingStudentId)?.photo || '';

    if (photoFile) {
      const formData = new FormData();
      formData.append('photo', photoFile);

      const uploadRes = await fetch(`${BASE_URL}/api/students/${encodeURIComponent(id)}/uploadPhoto`, {
        method: 'POST',
        body: formData,
      });

      if (uploadRes.ok) {
        const uploaded = await uploadRes.json();
        photoURL = uploaded.photo || '';
      } else {
        showToast('Photo upload failed', 'error');
      }
    }

    if (editingStudentId === null) {
      // Add new student
      if (students.find(s => s.id === id)) {
        document.getElementById('modalErrorMsg').textContent = 'Student ID already exists.';
        setButtonLoading(saveStudentBtn, false);
        return;
      }
      const res = await fetch(`${BASE_URL}/api/students`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name, mobile, photo: photoURL })
      });
      if (!res.ok) throw new Error('Failed to add student');
      students.push({ id, name, mobile, photo: photoURL });
      showToast('Student added successfully', 'success');
    } else {
      // Edit existing student
      const res = await fetch(`${BASE_URL}/api/students/${encodeURIComponent(editingStudentId)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name, mobile, photo: photoURL })
      });
      if (!res.ok) throw new Error('Failed to update student');
      const idx = students.findIndex(s => s.id === editingStudentId);
      if (idx !== -1) {
        students[idx].name = name;
        students[idx].mobile = mobile;
        students[idx].photo = photoURL;
      }
      showToast('Student updated successfully', 'success');
    }

    closeModal();
    renderTable();

  } catch (e) {
    document.getElementById('modalErrorMsg').textContent = e.message || 'Failed to save student';
    showToast('Error saving student', 'error');
  } finally {
    setButtonLoading(saveStudentBtn, false);
  }
}

  // Table Head
  tableHead.innerHTML = `<tr>
    <th>ID</th><th>Name</th>
    ${dates.map(d => `<th>${d.split('-')[2]}</th>`).join('')}
  </tr>`;

  // Table Body
  tableBody.innerHTML = students.map(student => {
    const row = [`<td>${escapeHTML(student.id)}</td>`, `<td>${escapeHTML(student.name)}</td>`];
    dates.forEach(date => {
      const status = attendance[date]?.[student.id] || '';
      row.push(`<td contenteditable="true" data-date="${date}" data-id="${student.id}">${status}</td>`);
    });
    return `<tr>${row.join('')}</tr>`;
  }).join('');
function checkPassword() {
  const pass = document.getElementById('adminPass').value;
  if (pass === 'teacher123') {
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('adminContent').style.display = 'block';

    console.log('Login triggered ‚úÖ Initializing Admin...');
    initAdmin();  // üî• Add this line
  } else {
    alert('Incorrect password');
  }
}

async function initAdmin() {
  console.log("üîÅ Loading students...");
  await loadStudents();
  console.log("‚úÖ Students:", students);

  console.log("üîÅ Loading attendance...");
  await loadAttendance();
  console.log("‚úÖ Attendance:", attendance);

  renderTable();
}


  // Listener to save when cell edited
  tableBody.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
    cell.addEventListener('blur', async () => {
      const studentId = cell.dataset.id;
      const date = cell.dataset.date;
      const status = cell.innerText.trim().toLowerCase();

      if (!['present', 'absent'].includes(status)) {
        showToast('Enter "present" or "absent" only.', 'error');
        cell.innerText = attendance[date]?.[studentId] || '';
        return;
      }

      const payload = { date, studentId, status };
      const existing = await fetch(`${BASE_URL}/api/attendance?date=${date}&studentId=${studentId}`);
      const data = await existing.json();

      if (data.length > 0) {
        // update
        await fetch(`${BASE_URL}/api/attendance/${data[0].id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        // new
        await fetch(`${BASE_URL}/api/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }

      showToast(`Attendance updated for ${date}`, 'success');
      // update local cache
      if (!attendance[date]) attendance[date] = {};
      attendance[date][studentId] = status;
    });
  });
}


 
document.addEventListener('DOMContentLoaded', () => {
  // Assign all your functions to window here
  window.checkPassword = checkPassword;
  window.logout = logout;
  window.viewAttendanceByDate = viewAttendanceByDate;
  window.showAddModal = showAddModal;
  window.closeModal = closeModal;
  window.saveStudent = saveStudent;
  window.editStudent = editStudent;
  window.deleteStudent = deleteStudent;
  window.generateAllQRCodes = generateAllQRCodes;
  window.downloadAllQRAsPDF = downloadAllQRAsPDF;
  window.showIndividualQRModal = showIndividualQRModal;
  window.exportAttendanceByDate = exportAttendanceByDate;
  window.generateMonthlyReport = generateMonthlyReport;
  window.exportMonthlyCSV = exportMonthlyCSV;

  // Ripple effect on all buttons
  document.querySelectorAll('button').forEach(btn => {
    btn.classList.add('ripple');
    btn.addEventListener('click', function(e) {
      const ripple = document.createElement('span');
      ripple.classList.add('ripple-effect');
      const rect = btn.getBoundingClientRect();
      ripple.style.width = ripple.style.height = Math.max(rect.width, rect.height) + 'px';
      ripple.style.left = e.clientX - rect.left - (parseInt(ripple.style.width)/2) + 'px';
      ripple.style.top = e.clientY - rect.top - (parseInt(ripple.style.height)/2) + 'px';
      btn.appendChild(ripple);
      setTimeout(() => ripple.remove(), 600);
    });
  });
});
})();
</script>

</body>
</html>
