<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Attendance - Full Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }

    #qrInput {
      font-size: 18px;
      padding: 10px;
      width: 300px;
      margin: 10px auto;
      border: 1px solid #ccc;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
      height: 24px;
    }

    .card {
      border: 2px solid #ccc;
      border-radius: 10px;
      background: white;
      margin: 10px;
      padding: 15px;
      width: 240px;
      display: inline-block;
      vertical-align: top;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
    }

    .present {
      background: #d4edda;
      border-color: green;
    }

    .absent {
      background: #f8d7da;
      border-color: red;
    }

    .student-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      overflow-x: auto;
    }

    .student-table th, .student-table td {
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 13px;
      text-align: center;
    }

    .student-table th {
      background: #e9ecef;
      position: sticky;
      top: 0;
    }

    .present-cell { background: #d4edda; color: green; }
    .absent-cell { background: #f8d7da; color: red; }

    button {
      padding: 10px 20px;
      margin: 20px 10px;
      font-size: 16px;
      cursor: pointer;
    }

    #adminLoginLink {
      display: block;
      margin-top: 10px;
      color: blue;
      text-decoration: underline;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .card { width: 90%; }
      .student-table { font-size: 12px; overflow-x: scroll; display: block; white-space: nowrap; }
    }
  </style>
</head>
<body>
  <h1>📅 Attendance Dashboard</h1>

  <input type="text" id="qrInput" placeholder="Click here then Scan QR Code ..." autofocus />
  <div id="status"></div>

  <div id="studentCards"></div>

  <h2 style="margin-top: 40px;">📊 Monthly Attendance Sheet</h2>
  <div id="monthlyTable"></div>

  <button onclick="exportCSV()">📤 Export Monthly Attendance</button>
  <a id="adminLoginLink" href="admin2.html">Admin Panel Login</a>

  <script>
    const BASE_URL = "https://attendance-app-r8y3.onrender.com";

    let students = [];
    let attendance = {};
    const today = new Date();
    const yyyy_mm = today.toISOString().slice(0, 7);
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const todayDate = today.toISOString().split("T")[0];

    const res = await fetch(`${BASE_URL}/api/attendance?date=${todayDate}`);
const data = await res.json();

if (Array.isArray(data)) {
  if (data.length === 0) {
    console.warn("📭 No attendance data yet for today.");
    attendance = {};
    return;
  } else {
    console.error("Expected single object but got array:", data);
    return;
  }
}

if (!data || typeof data !== 'object' || !data.records) {
  console.error("Invalid attendance data:", data);
  return;
}

attendance = data.records || {};


    async function saveAttendance() {
      const payload = {
        date: todayDate,
        records: attendance
      };
      try {
        const res = await fetch(`${BASE_URL}/api/attendance?date=${todayDate}`);
        const existing = await res.json();
        if (existing?._id) {
          await fetch(`${BASE_URL}/api/attendance/${existing._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          await fetch(`${BASE_URL}/api/attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
        console.log(`Attendance saved for ${todayDate}`);
      } catch (err) {
        console.error('❌ Error saving attendance:', err);
      }
    }

    function renderStudentCards() {
      const container = document.getElementById('studentCards');
      container.innerHTML = '';
      students.forEach(student => {
        const card = document.createElement('div');
        const isPresent = attendance[student.id];
        const photoUrl = student.photo || `https://i.pravatar.cc/100?u=${student.id}`;
        card.className = 'card ' + (isPresent ? 'present' : 'absent');
        card.innerHTML = `
          <img src="${photoUrl}" width="40" height="40" style="border-radius:50%;" />
          <h3>${student.name}</h3>
          <p>ID: ${student.id}</p>
          <p>📞 ${student.mobile}</p>
          <p><strong>Status Today:</strong> ${isPresent ? '✅ Present' : '❌ Absent'}</p>
        `;
        container.appendChild(card);
      });
    }

    function renderMonthlyTable() {
      const container = document.getElementById('monthlyTable');
      container.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'student-table';

      let header = `<tr><th>Name</th><th>ID</th>`;
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(`${yyyy_mm}-${String(d).padStart(2, '0')}`);
        if (dateObj.getDay() !== 0) header += `<th>${d}</th>`;
      }
      header += `<th>✅ Present</th><th>❌ Absent</th><th>📆 Total</th></tr>`;
      table.innerHTML += header;

      students.forEach(student => {
        let row = `<tr><td>${student.name}</td><td>${student.id}</td>`;
        let presentCount = 0, total = 0;

        for (let d = 1; d <= daysInMonth; d++) {
          const dateKey = `${yyyy_mm}-${String(d).padStart(2, '0')}`;
          const dateObj = new Date(dateKey);
          if (dateObj.getDay() === 0) continue;
          total++;
          const marked = attendance[student.id]?.[dateKey] || (todayDate === dateKey && attendance[student.id]);
          if (marked) {
            row += `<td class="present-cell">✔</td>`;
            presentCount++;
          } else {
            row += `<td class="absent-cell">✘</td>`;
          }
        }

        const absent = total - presentCount;
        row += `<td>${presentCount}</td><td>${absent}</td><td>${total}</td></tr>`;
        table.innerHTML += row;
      });

      container.appendChild(table);
    }

    function markAttendance(id) {
      const cleanId = id.trim().toUpperCase();
      const student = students.find(s => s.id === cleanId);
      const statusDiv = document.getElementById('status');
      const timeNow = new Date().toLocaleTimeString();

      if (!student) {
        const msg = `Unknown ID: ${cleanId}`;
        statusDiv.textContent = `⚠️ ${msg}`;
        statusDiv.style.color = 'red';
        speakText(msg);
        return;
      }

      if (attendance[cleanId]) {
        const msg = `${student.name} already marked present.`;
        statusDiv.textContent = `🔁 ${msg}`;
        statusDiv.style.color = 'orange';
        speakText(msg);
        return;
      }

      attendance[cleanId] = timeNow;
      saveAttendance();
      renderStudentCards();
      renderMonthlyTable();
      const msg = `${student.name} marked present at ${timeNow}`;
      statusDiv.textContent = `✅ ${msg}`;
      statusDiv.style.color = 'green';
      speakText(msg);
    }

    function speakText(text) {
      const synth = window.speechSynthesis;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      const setVoice = () => {
        const voices = synth.getVoices();
        const femaleVoice = voices.find(v =>
          v.name.toLowerCase().includes('female') ||
          v.name.toLowerCase().includes('woman') ||
          v.name.toLowerCase().includes('zira') ||
          v.name.toLowerCase().includes('karen')
        );
        utterance.voice = femaleVoice || voices[0];
        synth.speak(utterance);
      };
      if (synth.getVoices().length === 0) {
        synth.addEventListener('voiceschanged', setVoice);
      } else {
        setVoice();
      }
    }

    function exportCSV() {
      alert("📤 Export feature coming soon!");
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadStudents();
      await loadAttendance();
      renderStudentCards();
      renderMonthlyTable();

      document.getElementById('qrInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          markAttendance(this.value);
          this.value = '';
        }
      });

      window.addEventListener('storage', async function(e) {
        if (e.key.startsWith('attendance_') || e.key === 'students') {
          console.log("🔁 Data updated externally. Reloading...");
          await loadStudents();
          await loadAttendance();
          renderStudentCards();
          renderMonthlyTable();
        }
      });

      setInterval(() => {
        loadStudents();
      }, 10000);
    });
  </script>
</body>
</html>
