<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QR Attendance - Full Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; text-align: center; }

    #qrInput {
      font-size: 18px;
      padding: 10px;
      width: 300px;
      margin: 10px auto;
      border: 1px solid #ccc;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
      height: 24px;
    }

    .card {
      border: 2px solid #ccc;
      border-radius: 10px;
      background: white;
      margin: 10px;
      padding: 15px;
      width: 240px;
      display: inline-block;
      vertical-align: top;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .card img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
    }

    .present { background: #d4edda; border-color: green; }
    .absent { background: #f8d7da; border-color: red; }

    .student-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
      overflow-x: auto;
    }

    .student-table th, .student-table td {
      border: 1px solid #ccc;
      padding: 5px;
      font-size: 13px;
      text-align: center;
    }

    .student-table th {
      background: #e9ecef;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .present-cell { background: #d4edda; color: green; }
    .absent-cell { background: #f8d7da; color: red; }

    button {
      padding: 10px 20px;
      margin: 20px 10px;
      font-size: 16px;
      cursor: pointer;
    }

    #adminLoginLink {
      display: block;
      margin-top: 10px;
      color: blue;
      text-decoration: underline;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .card { width: 90%; }
      .student-table { font-size: 12px; overflow-x: scroll; display: block; white-space: nowrap; }
    }
  </style>
</head>
<body>
  <h1>üìÖ Attendance Dashboard</h1>

  <input type="text" id="qrInput" placeholder="Click here then Scan QR Code ..." autofocus />
  <div id="status"></div>

  <div id="studentCards"></div>

  <h2 style="margin-top: 40px;">üìä Monthly Attendance Sheet (Today‚Äôs Data)</h2>
  <div id="monthlyTable"></div>

  <button onclick="exportCSV()">üì§ Export Monthly Attendance</button>
  <a id="adminLoginLink" href="admin2.html">Admin Panel Login</a>

  <script>
    const BASE_URL = "https://attendance-app-r8y3.onrender.com";
    let students = [];
    let attendance = {};
    const today = new Date();
    const yyyy_mm = today.toISOString().slice(0, 7);
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const todayDate = today.toISOString().split("T")[0];

    async function loadStudents() {
      try {
        const response = await fetch(`${BASE_URL}/api/students`);
        students = await response.json();
      } catch (e) {
        console.error("‚ùå Failed to load students:", e);
        alert("‚ö†Ô∏è Failed to load student data.");
      }
    }

    async function loadAttendance() {
      try {
        const res = await fetch(`${BASE_URL}/api/attendance?date=${todayDate}`);
        const data = await res.json();

        if (Array.isArray(data)) {
          if (data.length === 0) {
            attendance = {};
          } else {
            attendance = data[0].records || {};
          }
        } else if (data?.records) {
          attendance = data.records;
        } else {
          attendance = {};
        }
      } catch (e) {
        console.error("‚ùå Failed to load attendance:", e);
        attendance = {};
      }
    }

    async function saveAttendance() {
      const payload = { date: todayDate, records: attendance };

      try {
        const res = await fetch(`${BASE_URL}/api/attendance?date=${todayDate}`);
        const existing = await res.json();

        if (Array.isArray(existing) && existing.length > 0 && existing[0]._id) {
          await fetch(`${BASE_URL}/api/attendance/${existing[0]._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          await fetch(`${BASE_URL}/api/attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }

        console.log(`‚úÖ Attendance saved for ${todayDate}`);
      } catch (err) {
        console.error("‚ùå Error saving attendance:", err);
      }
    }

    function renderStudentCards() {
      const container = document.getElementById('studentCards');
      container.innerHTML = '';
      students.forEach(student => {
        const isPresent = attendance[student.id];
        const photoUrl = student.photo || `https://i.pravatar.cc/100?u=${student.id}`;
        const card = document.createElement('div');
        card.className = 'card ' + (isPresent ? 'present' : 'absent');
        card.innerHTML = `
          <img src="${photoUrl}" width="80" height="80" />
          <h3>${student.name}</h3>
          <p>ID: ${student.id}</p>
          <p>üìû ${student.mobile}</p>
          <p><strong>Status Today:</strong> ${isPresent ? '‚úÖ Present' : '‚ùå Absent'}</p>
        `;
        container.appendChild(card);
      });
    }

    function renderMonthlyTable() {
      const container = document.getElementById('monthlyTable');
      container.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'student-table';

      // Header with days of month excluding Sundays
      let header = `<tr><th>Name</th><th>ID</th>`;
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(`${yyyy_mm}-${String(d).padStart(2, '0')}`);
        if (dateObj.getDay() !== 0) header += `<th>${d}</th>`;
      }
      header += `<th>‚úÖ</th><th>‚ùå</th><th>üìÜ Total</th></tr>`;
      table.innerHTML += header;

      students.forEach(student => {
        let row = `<tr><td>${student.name}</td><td>${student.id}</td>`;
        let presentCount = 0, total = 0;

        for (let d = 1; d <= daysInMonth; d++) {
          const dateKey = `${yyyy_mm}-${String(d).padStart(2, '0')}`;
          const dateObj = new Date(dateKey);
          if (dateObj.getDay() === 0) continue;

          total++;

          // Show checkmark only for today, rest absent
          const marked = (todayDate === dateKey) && attendance[student.id];
          if (marked) {
            row += `<td class="present-cell">‚úî</td>`;
            presentCount++;
          } else {
            row += `<td class="absent-cell">‚úò</td>`;
          }
        }

        const absent = total - presentCount;
        row += `<td>${presentCount}</td><td>${absent}</td><td>${total}</td></tr>`;
        table.innerHTML += row;
      });

      container.appendChild(table);
    }

    function showStatus(message, color) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.style.color = color;
      clearTimeout(statusDiv.timeout);
      statusDiv.timeout = setTimeout(() => {
        statusDiv.textContent = '';
      }, 5000);
    }

    function markAttendance(id) {
      const cleanId = id.trim().toUpperCase();
      const student = students.find(s => s.id.toUpperCase() === cleanId);

      if (!student) {
        const msg = `Unknown ID: ${cleanId}`;
        showStatus(`‚ö†Ô∏è ${msg}`, 'red');
        speakText(msg);
        return;
      }

      if (attendance[cleanId]) {
        const msg = `${student.name} already marked present.`;
        showStatus(`üîÅ ${msg}`, 'orange');
        speakText(msg);
        return;
      }

      const timeNow = new Date().toLocaleTimeString();
      attendance[cleanId] = timeNow;

      saveAttendance();
      renderStudentCards();
      renderMonthlyTable();

      const msg = `${student.name} marked present at ${timeNow}`;
      showStatus(`‚úÖ ${msg}`, 'green');
      speakText(msg);
    }

    function speakText(text) {
      const synth = window.speechSynthesis;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';

      function setVoice() {
        const voices = synth.getVoices();
        utterance.voice = voices.find(v =>
          v.name.toLowerCase().includes('zira') ||
          v.name.toLowerCase().includes('karen')
        ) || voices[0];
        synth.speak(utterance);
      }

      if (synth.getVoices().length === 0) {
        synth.addEventListener('voiceschanged', setVoice);
      } else {
        setVoice();
      }
    }

    function exportCSV() {
      let csv = 'Name,ID,';
      for (let d = 1; d <= daysInMonth; d++) {
        const dateKey = `${yyyy_mm}-${String(d).padStart(2, '0')}`;
        const dateObj = new Date(dateKey);
        if (dateObj.getDay() === 0) continue;
        csv += d + ',';
      }
      csv += 'Present,Absent,Total\n';

      students.forEach(student => {
        let row = `"${student.name}","${student.id}",`;
        let presentCount = 0, total = 0;

        for (let d = 1; d <= daysInMonth; d++) {
          const dateKey = `${yyyy_mm}-${String(d).padStart(2, '0')}`;
          const dateObj = new Date(dateKey);
          if (dateObj.getDay() === 0) continue;

          total++;
          const marked = (todayDate === dateKey) && attendance[student.id];
          if (marked) {
            row += '‚úî,';
            presentCount++;
          } else {
            row += '‚úò,';
          }
        }

        const absent = total - presentCount;
        row += `${presentCount},${absent},${total}\n`;
        csv += row;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `attendance_${yyyy_mm}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadStudents();
      await loadAttendance();
      renderStudentCards();
      renderMonthlyTable();

      document.getElementById('qrInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          markAttendance(this.value);
          this.value = '';
        }
      });

      window.addEventListener('storage', async function(e) {
        if (e.key.startsWith('attendance_') || e.key === 'students') {
          console.log("üîÅ External update. Reloading...");
          await loadStudents();
          await loadAttendance();
          renderStudentCards();
          renderMonthlyTable();
        }
      });

      setInterval(() => {
        loadStudents();
      }, 10000);
    });
  </script>
</body>
</html>
